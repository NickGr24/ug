{% extends 'base.html' %}

{% block title %}Dashboard - Control Acces{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <p class="text-muted mb-0">Registru Intrari / Iesiri</p>
    </div>
    {% if current_location %}
    <span class="badge bg-primary fs-6 py-2 px-3">
        <i class="bi bi-geo-alt me-1"></i>{{ current_location.name }}
    </span>
    {% endif %}
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'registry' or active_tab == 'employees' %}active{% endif %}"
                id="registry-tab"
                data-bs-toggle="tab"
                data-bs-target="#registry-panel"
                type="button"
                role="tab">
            <i class="bi bi-card-list me-2"></i>Registru
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'present' %}active{% endif %}"
                id="present-tab"
                data-bs-toggle="tab"
                data-bs-target="#present-panel"
                type="button"
                role="tab">
            <i class="bi bi-person-check me-2"></i>Prezenti acum
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'history' %}active{% endif %}"
                id="history-tab"
                data-bs-toggle="tab"
                data-bs-target="#history-panel"
                type="button"
                role="tab">
            <i class="bi bi-journal-text me-2"></i>Istoric
        </button>
    </li>
    {% if user.is_admin %}
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'settings' %}active{% endif %}"
                id="settings-tab"
                data-bs-toggle="tab"
                data-bs-target="#settings-panel"
                type="button"
                role="tab">
            <i class="bi bi-gear me-2"></i>Setari
        </button>
    </li>
    {% endif %}
</ul>

<!-- Tab Content -->
<div class="tab-content" id="mainTabContent">
    <!-- Registry Tab (combined employees + vehicles) -->
    <div class="tab-pane fade {% if active_tab == 'registry' or active_tab == 'employees' %}show active{% endif %}"
         id="registry-panel"
         role="tabpanel">
        <div id="registry-content"
             hx-get="{% url 'core:registry_tab' %}"
             hx-trigger="load, refreshList from:body"
             hx-swap="innerHTML">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Se incarca...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Present Tab -->
    <div class="tab-pane fade {% if active_tab == 'present' %}show active{% endif %}"
         id="present-panel"
         role="tabpanel">
        <div id="present-content"
             hx-get="{% url 'core:present_tab' %}"
             hx-trigger="revealed, refreshPresent from:body, every 30s"
             hx-swap="innerHTML">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Se incarca...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="tab-pane fade {% if active_tab == 'history' %}show active{% endif %}"
         id="history-panel"
         role="tabpanel">
        <div id="history-content"
             hx-get="{% url 'core:history_tab' %}"
             hx-trigger="revealed"
             hx-swap="innerHTML">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Se incarca...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    {% if user.is_admin %}
    <div class="tab-pane fade {% if active_tab == 'settings' %}show active{% endif %}"
         id="settings-panel"
         role="tabpanel">
        <div id="settings-content"
             hx-get="{% url 'core:settings_tab' %}"
             hx-trigger="revealed"
             hx-swap="innerHTML">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Se incarca...</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal for forms -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalLabel">Formular</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Form content loaded via HTMX -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Open modal when content is loaded via HTMX
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'modal-content') {
            var modalEl = document.getElementById('formModal');
            var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }
    });

    // Close modal on success
    document.body.addEventListener('closeModal', function() {
        var modalEl = document.getElementById('formModal');
        var modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
        }
        // Cleanup backdrop manually if needed
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.body.style.removeProperty('overflow');
    });

    // Also cleanup when modal is hidden via X button or clicking outside
    document.getElementById('formModal').addEventListener('hidden.bs.modal', function() {
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        document.body.style.removeProperty('overflow');
    });
</script>
{% endblock %}
