{% load custom_filters %}
<!-- History Tab Content - Paired Entry/Exit Records -->
<div class="card mb-4">
    <div class="card-body">
        <form hx-get="{% url 'core:history_tab' %}"
              hx-target="#history-content"
              hx-trigger="submit"
              class="row g-3 align-items-end">

            <div class="col-md-2">
                <label class="form-label">De la</label>
                <input type="date"
                       name="date_from"
                       class="form-control"
                       value="{{ filter_form.date_from.value|default:'' }}">
            </div>

            <div class="col-md-2">
                <label class="form-label">Pana la</label>
                <input type="date"
                       name="date_to"
                       class="form-control"
                       value="{{ filter_form.date_to.value|default:'' }}">
            </div>

            <div class="col-md-2">
                <label class="form-label">Tip</label>
                <select name="entity_type" class="form-select">
                    <option value="">Toate</option>
                    <option value="employee" {% if filter_form.entity_type.value == 'employee' %}selected{% endif %}>Angajat</option>
                    <option value="vehicle" {% if filter_form.entity_type.value == 'vehicle' %}selected{% endif %}>Vehicul</option>
                </select>
            </div>

            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel me-1"></i>Filtreaza
                </button>
                <a href="{% url 'core:history_export' %}?{{ request.GET.urlencode }}"
                   class="btn btn-outline-success ms-2">
                    <i class="bi bi-download me-1"></i>Export
                </a>
            </div>
        </form>

        <!-- Quick presets -->
        <div class="mt-3 d-flex gap-2 flex-wrap">
            <span class="text-muted align-self-center">Rapid:</span>
            <a href="#"
               class="btn btn-sm btn-outline-secondary"
               hx-get="{% url 'core:history_tab' %}?date_from={{ today }}&date_to={{ today }}"
               hx-target="#history-content">
                Azi
            </a>
            <a href="#"
               class="btn btn-sm btn-outline-secondary"
               hx-get="{% url 'core:history_tab' %}?date_from={{ yesterday }}&date_to={{ yesterday }}"
               hx-target="#history-content">
                Ieri
            </a>
            <a href="#"
               class="btn btn-sm btn-outline-secondary"
               hx-get="{% url 'core:history_tab' %}?date_from={{ week_ago }}&date_to={{ today }}"
               hx-target="#history-content">
                Ultimele 7 zile
            </a>
            <a href="#"
               class="btn btn-sm btn-outline-secondary"
               hx-get="{% url 'core:history_tab' %}"
               hx-target="#history-content">
                Toate
            </a>
        </div>
    </div>
</div>

{% if visits %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th style="width: 40px;">#</th>
                <th>Tip</th>
                <th>Nume/Numar</th>
                <th>Departament</th>
                <th>Intrare</th>
                <th>Iesire</th>
                <th>Durata</th>
                {% if user.is_admin %}<th>Locatie</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for visit in visits %}
            <tr>
                <td class="text-muted small">{{ forloop.counter }}</td>
                <td>
                    {% if visit.entity_type == 'employee' %}
                    <span class="badge bg-primary"><i class="bi bi-person"></i></span>
                    {% else %}
                    <span class="badge bg-info"><i class="bi bi-car-front"></i></span>
                    {% endif %}
                </td>
                <td class="fw-semibold">{{ visit.entity_name }}</td>
                <td>{{ visit.entity_department|default:"-" }}</td>
                <td>
                    <div>{{ visit.entry_time|date:"d.m.Y" }}</div>
                    <small class="text-muted">{{ visit.entry_time|time:"H:i" }}</small>
                </td>
                <td>
                    {% if visit.exit_time %}
                    <div>{{ visit.exit_time|date:"d.m.Y" }}</div>
                    <small class="text-muted">{{ visit.exit_time|time:"H:i" }}</small>
                    {% else %}
                    <span class="badge bg-success">Pe teritoriu</span>
                    {% endif %}
                </td>
                <td>
                    {% if visit.exit_time %}
                    <small class="text-muted">{{ visit.entry_time|duration_until:visit.exit_time }}</small>
                    {% else %}
                    <span class="text-success">-</span>
                    {% endif %}
                </td>
                {% if user.is_admin %}<td><span class="badge bg-secondary">{{ visit.entry_location.code }}</span></td>{% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="text-muted small mt-3">
    <i class="bi bi-info-circle me-1"></i>
    Afisate {{ visits|length }} vizite
</div>

{% else %}
<div class="empty-state">
    <i class="bi bi-journal-x d-block"></i>
    <p class="mb-0">Nu exista inregistrari pentru filtrele selectate.</p>
</div>
{% endif %}
