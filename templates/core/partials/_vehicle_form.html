<h5 class="modal-title mb-4">
    {% if object %}Editare vehicul{% else %}Adaugare vehicul{% endif %}
</h5>

{% if form.non_field_errors %}
<div class="alert alert-danger mb-3">
    {% for error in form.non_field_errors %}
    <div>{{ error }}</div>
    {% endfor %}
</div>
{% endif %}

<form hx-post="{{ request.path }}"
      hx-target="#modal-content"
      hx-swap="innerHTML">
    {% csrf_token %}

    <div class="mb-3">
        <label for="id_plate_number" class="form-label">Numar inmatriculare <span class="text-danger">*</span></label>
        {{ form.plate_number }}
        {% if form.plate_number.errors %}
        <div class="text-danger small">{{ form.plate_number.errors.0 }}</div>
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="id_descriere" class="form-label">Descriere</label>
        {{ form.descriere }}
        {% if form.descriere.errors %}
        <div class="text-danger small">{{ form.descriere.errors.0 }}</div>
        {% endif %}
    </div>

    <div class="mb-3 position-relative">
        <label for="id_proprietar" class="form-label">Proprietar (angajat)</label>
        <input type="text"
               name="proprietar"
               id="id_proprietar"
               class="form-control"
               placeholder="Introduceti numele proprietarului"
               value="{{ form.proprietar.value|default:'' }}"
               autocomplete="off"
               oninput="searchProprietar(this.value)">
        <div id="proprietar-suggestions"
             class="position-absolute w-100 bg-white border rounded-bottom shadow-sm"
             style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
        {% if form.proprietar.errors %}
        <div class="text-danger small">{{ form.proprietar.errors.0 }}</div>
        {% endif %}
        <div class="form-text small">
            <i class="bi bi-info-circle me-1"></i>Daca proprietarul este angajat, intrarea vehiculului va inregistra automat si intrarea angajatului.
        </div>
    </div>

    <script>
        var searchTimeout = null;

        function searchProprietar(query) {
            clearTimeout(searchTimeout);
            var suggestions = document.getElementById('proprietar-suggestions');

            if (query.length < 2) {
                suggestions.innerHTML = '';
                suggestions.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(function() {
                fetch('{% url "core:htmx_employee_autocomplete" %}?q=' + encodeURIComponent(query))
                    .then(response => response.text())
                    .then(html => {
                        suggestions.innerHTML = html;
                        suggestions.style.display = html.trim() ? 'block' : 'none';
                    });
            }, 300);
        }

        function selectProprietar(name) {
            document.getElementById('id_proprietar').value = name;
            document.getElementById('proprietar-suggestions').style.display = 'none';
            document.getElementById('proprietar-suggestions').innerHTML = '';
        }

        document.addEventListener('click', function(evt) {
            var proprietarInput = document.getElementById('id_proprietar');
            var suggestions = document.getElementById('proprietar-suggestions');
            if (proprietarInput && suggestions && evt.target !== proprietarInput && !suggestions.contains(evt.target)) {
                suggestions.style.display = 'none';
            }
        });
    </script>

    {% if not request.user.is_officer %}
    <div class="mb-3">
        <label for="id_location" class="form-label">Locatie <span class="text-danger">*</span></label>
        {{ form.location }}
        {% if form.location.errors %}
        <div class="text-danger small">{{ form.location.errors.0 }}</div>
        {% endif %}
    </div>
    {% endif %}

    {% if object %}
    <div class="mb-3">
        <div class="form-check">
            {{ form.activ }}
            <label class="form-check-label" for="id_activ">Activ</label>
        </div>
    </div>
    {% endif %}

    <div class="d-flex gap-2 justify-content-end mt-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuleaza</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i>Salveaza
        </button>
    </div>
</form>
